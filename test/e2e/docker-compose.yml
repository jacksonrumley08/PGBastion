# PostgreSQL backends for pgbastion end-to-end testing.
# Runs 3 PostgreSQL instances that pgbastion will route to.
# pgbastion manages cluster state via its internal Raft consensus.

services:
  # Primary PostgreSQL instance
  postgres1:
    image: postgres:17
    container_name: pgbastion-pg1
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
    command:
      - postgres
      - -c
      - wal_level=replica
      - -c
      - max_wal_senders=3
      - -c
      - max_replication_slots=3
    ports:
      - "15432:5432"
    networks:
      pgbastion-net:
        ipv4_address: 172.28.0.11
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Replica PostgreSQL instance 1
  postgres2:
    image: postgres:17
    container_name: pgbastion-pg2
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
    command:
      - postgres
      - -c
      - wal_level=replica
    ports:
      - "15433:5432"
    networks:
      pgbastion-net:
        ipv4_address: 172.28.0.12
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Replica PostgreSQL instance 2
  postgres3:
    image: postgres:17
    container_name: pgbastion-pg3
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
    command:
      - postgres
      - -c
      - wal_level=replica
    ports:
      - "15434:5432"
    networks:
      pgbastion-net:
        ipv4_address: 172.28.0.13
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 3s
      retries: 5

networks:
  pgbastion-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/24
